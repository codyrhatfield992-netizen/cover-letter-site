<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CoverCraft â€” AI Cover Letter Generator</title>
  <meta name="description" content="Generate a tailored cover letter from a job description + your resume. 3 free generations." />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/assets/pdf.min.js"></script>

  <style>
    :root {
      --bg: #0a0e1a;
      --card: rgba(255,255,255,.04);
      --card-hover: rgba(255,255,255,.07);
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.55);
      --line: rgba(255,255,255,.08);
      --accent: #6366f1;
      --accent2: #22c55e;
      --danger: #ef4444;
      --shadow: 0 24px 80px rgba(0,0,0,.5);
      --radius: 20px;
      --radius2: 14px;
      --radius3: 10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before, body::after {
      content: '';
      position: fixed;
      border-radius: 50%;
      filter: blur(120px);
      z-index: 0;
      pointer-events: none;
    }
    body::before {
      width: 800px; height: 600px;
      top: -200px; left: -150px;
      background: radial-gradient(circle, rgba(99,102,241,.3), transparent 70%);
      animation: floatBlob1 20s ease-in-out infinite;
    }
    body::after {
      width: 700px; height: 500px;
      bottom: -100px; right: -100px;
      background: radial-gradient(circle, rgba(34,197,94,.2), transparent 70%);
      animation: floatBlob2 25s ease-in-out infinite;
    }

    @keyframes floatBlob1 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(60px, 40px) scale(1.1); }
      66% { transform: translate(-30px, 60px) scale(0.95); }
    }
    @keyframes floatBlob2 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(-50px, -30px) scale(1.05); }
      66% { transform: translate(40px, -50px) scale(0.9); }
    }

    a { color: inherit; text-decoration: none; }

    .wrap {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px 100px;
    }

    /* ---- NAVIGATION ---- */
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 16px 24px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: 999px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      margin-bottom: 40px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 800;
      font-size: 17px;
      letter-spacing: -0.3px;
    }

    .brand-icon {
      width: 36px; height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      box-shadow: 0 4px 16px rgba(99,102,241,.3);
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-user {
      font-size: 13px;
      color: var(--muted);
      margin-right: 6px;
    }

    /* ---- HERO SECTION ---- */
    .hero-header {
      text-align: center;
      margin-bottom: 48px;
      padding: 0 20px;
    }

    .hero-header h1 {
      font-size: clamp(36px, 5vw, 56px);
      font-weight: 900;
      line-height: 1.08;
      letter-spacing: -1.5px;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #fff 30%, rgba(255,255,255,.6));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-header p {
      font-size: 18px;
      color: var(--muted);
      max-width: 560px;
      margin: 0 auto 24px;
      line-height: 1.6;
    }

    .pricing-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: linear-gradient(135deg, rgba(99,102,241,.15), rgba(34,197,94,.1));
      border: 1px solid rgba(99,102,241,.25);
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .pricing-pill strong {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ---- STEP INDICATOR ---- */
    .steps {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      margin-bottom: 40px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      transition: all .3s ease;
    }

    .step .step-num {
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
      font-weight: 800;
      border: 2px solid var(--line);
      background: transparent;
      transition: all .3s ease;
      flex-shrink: 0;
    }

    .step.active { color: var(--text); }

    .step.active .step-num {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
    }

    .step.done .step-num {
      border-color: var(--accent2);
      background: var(--accent2);
      color: #fff;
    }

    .step.done { color: var(--accent2); }

    .step-connector {
      width: 40px;
      height: 2px;
      background: var(--line);
      transition: background .3s ease;
    }

    .step-connector.done { background: var(--accent2); }

    /* ---- FEATURES GRID ---- */
    .features {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 40px;
    }

    @media (max-width: 700px) {
      .features { grid-template-columns: 1fr; }
    }

    .feature-card {
      padding: 24px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      transition: background .2s, border-color .2s;
    }

    .feature-card:hover {
      background: var(--card-hover);
      border-color: rgba(255,255,255,.12);
    }

    .feature-icon {
      width: 42px; height: 42px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px;
      margin-bottom: 14px;
    }

    .feature-card h3 { font-size: 15px; font-weight: 700; margin-bottom: 6px; }
    .feature-card span { font-size: 13px; color: var(--muted); line-height: 1.5; }

    /* ---- MAIN GRID ---- */
    .main-grid {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 20px;
      align-items: start;
    }

    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow: hidden;
    }

    .card-inner { padding: 24px; }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title .indicator {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent2);
      box-shadow: 0 0 8px rgba(34,197,94,.5);
    }

    /* ---- FORM CONTROLS ---- */
    label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
    }

    textarea {
      width: 100%;
      min-height: 170px;
      resize: vertical;
      padding: 14px 16px;
      border-radius: var(--radius2);
      border: 1px solid var(--line);
      background: rgba(0,0,0,.3);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      outline: none;
      line-height: 1.5;
      transition: border-color .2s, box-shadow .2s;
    }

    textarea:focus {
      border-color: rgba(99,102,241,.5);
      box-shadow: 0 0 0 4px rgba(99,102,241,.1);
    }

    textarea::placeholder { color: rgba(255,255,255,.25); }

    .input-group { margin-bottom: 16px; }

    select {
      appearance: none;
      border-radius: var(--radius3);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 14px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      outline: none;
      transition: border-color .2s;
    }

    select:focus { border-color: rgba(99,102,241,.5); }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: var(--radius3);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 18px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all .15s ease;
      text-decoration: none;
    }

    .btn:hover {
      background: rgba(255,255,255,.1);
      border-color: rgba(255,255,255,.15);
      transform: translateY(-1px);
    }

    .btn:active { transform: translateY(0); }

    .btn.primary {
      border: 0;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      font-weight: 800;
      box-shadow: 0 8px 24px rgba(99,102,241,.3);
    }

    .btn.primary:hover { box-shadow: 0 12px 32px rgba(99,102,241,.4); }

    .btn.ghost {
      background: transparent;
      border-color: transparent;
      color: var(--muted);
    }

    .btn.ghost:hover { color: var(--text); background: rgba(255,255,255,.05); }

    .btn.sm { padding: 7px 12px; font-size: 12px; }

    .btn:disabled {
      opacity: .45;
      cursor: not-allowed;
      transform: none !important;
    }

    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .row.between { justify-content: space-between; }

    /* ---- PDF UPLOAD ---- */
    .pdf-upload {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      padding: 14px 18px;
      border-radius: var(--radius2);
      border: 2px dashed rgba(99,102,241,.25);
      background: rgba(99,102,241,.04);
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
      transition: border-color .2s, background .2s;
    }

    .pdf-upload:hover {
      border-color: rgba(99,102,241,.4);
      background: rgba(99,102,241,.08);
    }

    .pdf-upload input[type="file"] { font-size: 12px; color: var(--muted); }

    .pdf-upload input[type="file"]::file-selector-button {
      background: rgba(255,255,255,.08);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 5px 10px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 8px;
    }

    /* ---- OUTPUT AREA ---- */
    .out-wrap { position: relative; min-height: 260px; }

    .out {
      padding: 20px;
      border-radius: var(--radius2);
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      min-height: 260px;
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 14px;
      color: rgba(255,255,255,.8);
    }

    .out-wrap.locked .out { user-select: none; }

    .out-wrap.locked::after {
      content: '';
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 70%;
      background: linear-gradient(to bottom, transparent 0%, rgba(10,14,26,.95) 60%);
      border-radius: 0 0 var(--radius2) var(--radius2);
      pointer-events: none;
    }

    .paywall-overlay {
      display: none;
      position: absolute;
      left: 50%; bottom: 24px;
      transform: translateX(-50%);
      z-index: 2;
      text-align: center;
      width: 90%;
      max-width: 360px;
    }

    .out-wrap.locked .paywall-overlay { display: block; }

    .paywall-card {
      background: rgba(20,24,40,.95);
      border: 1px solid rgba(99,102,241,.3);
      border-radius: var(--radius2);
      padding: 24px;
      backdrop-filter: blur(16px);
    }

    .paywall-card h3 { font-size: 16px; font-weight: 800; margin-bottom: 8px; }
    .paywall-card p { font-size: 13px; color: var(--muted); margin-bottom: 16px; line-height: 1.5; }

    .paywall-card .btn {
      width: 100%;
      justify-content: center;
      padding: 12px;
      font-size: 14px;
    }

    /* ---- GENERATION COUNTER ---- */
    .gen-counter {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      background: rgba(99,102,241,.1);
      border: 1px solid rgba(99,102,241,.2);
      color: rgba(255,255,255,.7);
    }

    .gen-counter.pro {
      background: rgba(34,197,94,.1);
      border-color: rgba(34,197,94,.2);
      color: #4ade80;
    }

    .gen-counter.exhausted {
      background: rgba(239,68,68,.1);
      border-color: rgba(239,68,68,.2);
      color: #fca5a5;
    }

    /* ---- LOADING SPINNER ---- */
    .loading-container {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      gap: 20px;
    }

    .loading-container.active { display: flex; }

    .spinner {
      width: 48px; height: 48px;
      border-radius: 50%;
      border: 3px solid var(--line);
      border-top-color: var(--accent);
      animation: spin .8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: .5; }
      50% { opacity: 1; }
    }

    /* ---- TOAST ---- */
    .toast {
      display: none;
      position: fixed;
      bottom: 28px;
      right: 28px;
      z-index: 9999;
      padding: 14px 20px;
      border-radius: var(--radius3);
      border: 1px solid rgba(239,68,68,.3);
      background: rgba(239,68,68,.12);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      color: rgba(255,255,255,.9);
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 12px 40px rgba(0,0,0,.4);
      animation: slideIn .25s ease;
    }

    .toast.ok {
      border-color: rgba(34,197,94,.3);
      background: rgba(34,197,94,.12);
    }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* ---- FOOTER ---- */
    .site-footer {
      margin-top: 48px;
      padding: 24px;
      border-top: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 12px;
      color: var(--muted);
    }

    .footer-links { display: flex; gap: 16px; }
    .footer-links a:hover { color: var(--text); }

    /* ---- MODAL ---- */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
      animation: fadeIn .2s ease;
    }

    .modal-overlay.active { display: flex; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal {
      width: 100%;
      max-width: 420px;
      margin: 20px;
      background: #131825;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 32px 100px rgba(0,0,0,.6);
      overflow: hidden;
      animation: modalSlide .25s ease;
      position: relative;
    }

    @keyframes modalSlide {
      from { transform: translateY(30px) scale(.97); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .modal-header { padding: 24px 24px 0; text-align: center; }

    .modal-header .modal-icon {
      width: 56px; height: 56px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(99,102,241,.2), rgba(34,197,94,.15));
      border: 1px solid rgba(99,102,241,.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
    }

    .modal-header h2 { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 8px; }
    .modal-header p { font-size: 14px; color: var(--muted); line-height: 1.5; }

    .modal-body { padding: 24px; }
    .modal-body .form-group { margin-bottom: 14px; }
    .modal-body .form-group label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--muted); }

    .modal-body .form-group input {
      width: 100%;
      padding: 12px 14px;
      border-radius: var(--radius3);
      border: 1px solid var(--line);
      background: rgba(0,0,0,.3);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    .modal-body .form-group input:focus {
      border-color: rgba(99,102,241,.5);
      box-shadow: 0 0 0 3px rgba(99,102,241,.1);
    }

    .modal-body .form-group input::placeholder { color: rgba(255,255,255,.25); }

    .modal-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 6px; }

    .modal-actions .btn {
      width: 100%;
      padding: 12px;
      justify-content: center;
      font-size: 14px;
      border-radius: var(--radius3);
    }

    .modal-footer { padding: 0 24px 20px; text-align: center; }
    .modal-footer span { font-size: 12px; color: var(--muted); }
    .modal-footer a { color: var(--accent); font-weight: 600; cursor: pointer; }
    .modal-footer a:hover { text-decoration: underline; }

    .modal-close {
      position: absolute;
      top: 16px; right: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      color: var(--muted);
      width: 32px; height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
      transition: all .15s;
    }

    .modal-close:hover { background: rgba(255,255,255,.1); color: var(--text); }

    .modal-toast {
      display: none;
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: var(--radius3);
      border: 1px solid rgba(239,68,68,.3);
      background: rgba(239,68,68,.1);
      color: rgba(255,255,255,.85);
      font-size: 13px;
      text-align: center;
    }

    .modal-toast.ok {
      border-color: rgba(34,197,94,.3);
      background: rgba(34,197,94,.1);
    }

    /* ---- MISC ---- */
    .divider { height: 1px; background: var(--line); margin: 16px 0; }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tag.green {
      background: rgba(34,197,94,.12);
      color: #4ade80;
      border: 1px solid rgba(34,197,94,.2);
    }

    .muted { color: var(--muted); font-size: 13px; }

    @media (max-width: 900px) {
      .navbar { border-radius: var(--radius2); padding: 12px 16px; }
      .hero-header h1 { font-size: 32px; }
      .features { gap: 10px; }
      .steps { flex-wrap: wrap; gap: 4px; }
      .step { padding: 8px 12px; font-size: 12px; }
      .step-connector { width: 20px; }
    }

    @media (max-width: 600px) {
      .nav-actions { flex-wrap: wrap; }
      .wrap { padding: 16px 12px 60px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- NAVBAR -->
    <nav class="navbar">
      <div class="brand">
        <div class="brand-icon">&#9998;</div>
        CoverCraft
      </div>
      <div class="nav-actions">
        <span class="nav-user" id="authStatus"></span>
        <button class="btn sm" id="navLogin" type="button">Sign in</button>
        <button class="btn sm primary" id="navSignup" type="button">Get Started</button>
        <button class="btn sm ghost" id="logout" type="button" style="display:none;">Log out</button>
        <button class="btn sm primary" id="pay" type="button" style="display:none;">Upgrade</button>
      </div>
    </nav>

    <!-- HERO -->
    <section class="hero-header">
      <h1>Cover letters that actually<br/>sound like you.</h1>
      <p>Upload your resume, paste a job description, and get a polished, tailored cover letter in seconds.</p>
      <div class="pricing-pill">
        3 free generations &middot; then <strong>&nbsp;$9.99/month</strong>&nbsp; for unlimited
      </div>
    </section>

    <!-- STEP INDICATOR -->
    <div class="steps" id="stepIndicator">
      <div class="step active" id="step1">
        <span class="step-num">1</span>
        <span>Upload Resume</span>
      </div>
      <div class="step-connector" id="conn1"></div>
      <div class="step" id="step2">
        <span class="step-num">2</span>
        <span>Paste Job Description</span>
      </div>
      <div class="step-connector" id="conn2"></div>
      <div class="step" id="step3">
        <span class="step-num">3</span>
        <span>Generate Cover Letter</span>
      </div>
    </div>

    <!-- FEATURES -->
    <div class="features">
      <div class="feature-card">
        <div class="feature-icon" style="background: rgba(99,102,241,.12); border: 1px solid rgba(99,102,241,.2);">&#9889;</div>
        <h3>Lightning Fast</h3>
        <span>Generate a tailored cover letter in under 30 seconds. No more staring at a blank page.</span>
      </div>
      <div class="feature-card">
        <div class="feature-icon" style="background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.2);">&#9996;</div>
        <h3>Sounds Human</h3>
        <span>No robotic filler or generic fluff. Every letter is natural and specific to you.</span>
      </div>
      <div class="feature-card">
        <div class="feature-icon" style="background: rgba(236,72,153,.12); border: 1px solid rgba(236,72,153,.2);">&#127919;</div>
        <h3>Job-Tailored</h3>
        <span>Matches your experience to the job description so every letter hits the right notes.</span>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-grid">

      <!-- LEFT: INPUT -->
      <div class="card">
        <div class="card-inner">
          <div class="card-title">
            <span>&#9998; &nbsp;Input</span>
            <div class="indicator"></div>
          </div>

          <!-- Resume Upload (Step 1 - Primary) -->
          <div class="input-group">
            <label>
              <span>Your Resume</span>
              <span id="resumeCount">0 chars</span>
            </label>
            <div class="pdf-upload">
              <span>&#128196;</span>
              <input id="resumePdf" type="file" accept="application/pdf,.pdf" />
              <span>Upload PDF (max 20MB) to auto-summarize</span>
            </div>
            <textarea id="resume" placeholder="Upload a resume PDF to populate this field." readonly style="margin-top: 8px;"></textarea>
          </div>

          <!-- Job Description (Step 2) -->
          <div class="input-group">
            <label>
              <span>Job Description</span>
              <span id="jobCount">0 chars</span>
            </label>
            <textarea id="job" placeholder="Paste the job description here..."></textarea>
          </div>

          <div class="divider"></div>

          <div class="row between">
            <div class="row" style="gap: 8px;">
              <select id="tone" title="Tone">
                <option value="confident and natural" selected>Confident & natural</option>
                <option value="friendly and warm">Friendly & warm</option>
                <option value="direct and professional">Direct & professional</option>
                <option value="bold and persuasive">Bold & persuasive</option>
              </select>
              <span class="gen-counter" id="genCounter">3 / 3 free remaining</span>
            </div>

            <div class="row" style="gap: 8px;">
              <button class="btn ghost sm" id="sample" type="button">Load sample</button>
              <button class="btn sm" id="retry" type="button">Try Again</button>
              <button class="btn primary" id="generate" type="button">Generate</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: OUTPUT -->
      <div class="card">
        <div class="card-inner">
          <div class="card-title">
            <span>&#128196; &nbsp;Result</span>
            <span class="tag green" id="status">Ready</span>
          </div>

          <div class="out-wrap" id="outputWrap">
            <div class="loading-container" id="loadingState">
              <div class="spinner"></div>
              <span class="loading-text">Tailoring your cover letter...</span>
            </div>
            <div id="output" class="out">Your generated cover letter will appear here.</div>
            <div class="paywall-overlay">
              <div class="paywall-card">
                <h3>Unlock your full cover letter</h3>
                <p>Unlimited generations for $9.99/month. Cancel anytime.</p>
                <button class="btn primary" id="paywallUpgrade" type="button">Upgrade Now</button>
              </div>
            </div>
          </div>

          <div class="row between" style="margin-top: 14px;">
            <div class="row" style="gap: 8px;">
              <button class="btn sm" id="copy" type="button">Copy</button>
              <button class="btn sm" id="download" type="button">Download</button>
              <button class="btn sm ghost" id="clear" type="button">Clear</button>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- FOOTER -->
    <footer class="site-footer">
      <span>CoverCraft &mdash; AI-powered cover letters</span>
      <div class="footer-links">
        <a href="#">Privacy</a>
        <a href="#">Terms</a>
      </div>
    </footer>
  </div>

  <!-- EMAIL MODAL (invisible account creation) -->
  <div class="modal-overlay" id="emailModal">
    <div class="modal">
      <button class="modal-close" id="emailModalClose" type="button">&#10005;</button>
      <div class="modal-header">
        <div class="modal-icon">&#9993;</div>
        <h2>Enter your email to generate</h2>
        <p>We'll create your account automatically so you can access your cover letters.</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Email address</label>
          <input id="emailInput" type="email" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div id="emailModalToast" class="modal-toast"></div>
        <div class="modal-actions">
          <button class="btn primary" id="emailSubmit" type="button">Continue</button>
        </div>
      </div>
      <div class="modal-footer">
        <span>Already have an account? <a id="switchToLogin">Sign in</a></span>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal-overlay" id="loginModal">
    <div class="modal">
      <button class="modal-close" id="modalClose" type="button">&#10005;</button>
      <div class="modal-header">
        <div class="modal-icon">&#128274;</div>
        <h2 id="modalTitle">Sign in</h2>
        <p id="modalSubtitle">Welcome back! Sign in to your account.</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Email address</label>
          <input id="modalEmail" type="email" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input id="modalPassword" type="password" placeholder="Your password" autocomplete="current-password" />
        </div>
        <div id="modalToast" class="modal-toast"></div>
        <div class="modal-actions">
          <button class="btn primary" id="modalLoginBtn" type="button">Sign in</button>
          <button class="btn" id="modalSignupBtn" type="button" style="display:none;">Create account</button>
        </div>
      </div>
      <div class="modal-footer">
        <span id="modalSwitch">Don't have an account? <a id="modalSwitchLink">Sign up</a></span>
      </div>
    </div>
  </div>

  <!-- GLOBAL TOAST -->
  <div id="toast" class="toast"></div>

  <script>
    async function loadScript(src) {
      return new Promise(function(resolve, reject) {
        var s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = function() { resolve(true); };
        s.onerror = function() { reject(new Error("Failed to load " + src)); };
        document.head.appendChild(s);
      });
    }

    async function ensurePdfLibLoaded() {
      if (window.pdfjsLib && pdfjsLib.getDocument) return true;
      var sources = [
        "/assets/pdf.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js",
        "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.js"
      ];
      for (var i = 0; i < sources.length; i++) {
        try {
          await loadScript(sources[i]);
          if (window.pdfjsLib && pdfjsLib.getDocument) return true;
        } catch (_) {}
      }
      return false;
    }

    // PDF.js worker
    if (window.pdfjsLib?.GlobalWorkerOptions) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "/assets/pdf.worker.min.js";
    }

    // ---- STATE ----
    let supabaseClient = null;
    let currentUser = null;
    let profileData = {
      is_pro: false,
      subscription_status: "none",
      generations_used: 0,
      free_limit: 3,
    };
    let lastGeneratedText = "";
    let isGenerating = false;
    let appInitError = "";
    let localDevMode = false;
    let resumeLoadedFromPdf = false;
    let lastResumeUploadError = "";
    const MAX_RESUME_FILE_BYTES = 20 * 1024 * 1024;

    const LOCAL_STORAGE_KEYS = {
      resume: "cc_resume",
      job: "cc_job",
      resumeSource: "cc_resume_source",
    };

    function getLocalGenerationKey() {
      return currentUser && currentUser.id ? "cc_local_gen_used_" + currentUser.id : null;
    }

    function loadLocalGenerationUsed() {
      var key = getLocalGenerationKey();
      if (!key) return 0;
      try {
        var raw = localStorage.getItem(key);
        var n = parseInt(raw || "0", 10);
        return Number.isFinite(n) && n > 0 ? n : 0;
      } catch (_) {
        return 0;
      }
    }

    function saveLocalGenerationUsed(value) {
      var key = getLocalGenerationKey();
      if (!key) return;
      try {
        localStorage.setItem(key, String(Math.max(0, value || 0)));
      } catch (_) {}
    }

    // ---- ELEMENTS ----
    const els = {
      navLogin: document.getElementById("navLogin"),
      navSignup: document.getElementById("navSignup"),
      logout: document.getElementById("logout"),
      authStatus: document.getElementById("authStatus"),
      job: document.getElementById("job"),
      resume: document.getElementById("resume"),
      resumePdf: document.getElementById("resumePdf"),
      tone: document.getElementById("tone"),
      generate: document.getElementById("generate"),
      output: document.getElementById("output"),
      outputWrap: document.getElementById("outputWrap"),
      loadingState: document.getElementById("loadingState"),
      status: document.getElementById("status"),
      toast: document.getElementById("toast"),
      copy: document.getElementById("copy"),
      download: document.getElementById("download"),
      clear: document.getElementById("clear"),
      sample: document.getElementById("sample"),
      retry: document.getElementById("retry"),
      jobCount: document.getElementById("jobCount"),
      resumeCount: document.getElementById("resumeCount"),
      pay: document.getElementById("pay"),
      paywallUpgrade: document.getElementById("paywallUpgrade"),
      genCounter: document.getElementById("genCounter"),
      step1: document.getElementById("step1"),
      step2: document.getElementById("step2"),
      step3: document.getElementById("step3"),
      conn1: document.getElementById("conn1"),
      conn2: document.getElementById("conn2"),
      emailModal: document.getElementById("emailModal"),
      emailModalClose: document.getElementById("emailModalClose"),
      emailInput: document.getElementById("emailInput"),
      emailSubmit: document.getElementById("emailSubmit"),
      emailModalToast: document.getElementById("emailModalToast"),
      switchToLogin: document.getElementById("switchToLogin"),
      loginModal: document.getElementById("loginModal"),
      modalClose: document.getElementById("modalClose"),
      modalEmail: document.getElementById("modalEmail"),
      modalPassword: document.getElementById("modalPassword"),
      modalLoginBtn: document.getElementById("modalLoginBtn"),
      modalSignupBtn: document.getElementById("modalSignupBtn"),
      modalToast: document.getElementById("modalToast"),
      modalTitle: document.getElementById("modalTitle"),
      modalSubtitle: document.getElementById("modalSubtitle"),
      modalSwitchLink: document.getElementById("modalSwitchLink"),
      modalSwitch: document.getElementById("modalSwitch"),
    };

    // ---- TOAST ----
    function setToast(msg, ok) {
      els.toast.className = "toast" + (ok ? " ok" : "");
      els.toast.textContent = msg;
      els.toast.style.display = "block";
      setTimeout(function() { els.toast.style.display = "none"; }, 3500);
    }

    function setModalToast(el, msg, ok) {
      el.className = "modal-toast" + (ok ? " ok" : "");
      el.textContent = msg;
      el.style.display = "block";
      setTimeout(function() { el.style.display = "none"; }, 4000);
    }

    function getAppNotReadyMessage() {
      return appInitError || "App is still loading. Please try again.";
    }

    function canUseLocalDevMode() {
      var host = (window.location.hostname || "").toLowerCase();
      return host === "localhost" || host === "127.0.0.1" || host.endsWith(".local");
    }

    function enableLocalDevMode(reason) {
      localDevMode = true;
      if (reason) appInitError = reason;
      els.authStatus.textContent = "Local dev mode";
      els.navLogin.style.display = "none";
      els.navSignup.style.display = "none";
      els.logout.style.display = "none";
      els.pay.style.display = "none";
      updateGenCounter();
      updateGenerateButton();
      setToast("Local dev mode enabled. Auth and billing are bypassed.", true);
    }

    // ---- CHAR COUNTS ----
    function count(el, outEl) {
      outEl.textContent = (el.value || "").length + " chars";
    }
    els.job.addEventListener("input", function() {
      count(els.job, els.jobCount);
      updateSteps();
      autoSave();
    });
    els.resume.addEventListener("input", function() {
      count(els.resume, els.resumeCount);
      updateSteps();
      autoSave();
    });

    // ---- AUTO-SAVE ----
    var saveTimer = null;
    function autoSave() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(function() {
        try {
          localStorage.setItem(LOCAL_STORAGE_KEYS.resume, resumeLoadedFromPdf ? els.resume.value : "");
          localStorage.setItem(LOCAL_STORAGE_KEYS.resumeSource, resumeLoadedFromPdf ? "pdf" : "");
          localStorage.setItem(LOCAL_STORAGE_KEYS.job, els.job.value);
        } catch (_) {}
      }, 500);
    }

    function loadSaved() {
      try {
        var savedResume = localStorage.getItem(LOCAL_STORAGE_KEYS.resume);
        var savedResumeSource = localStorage.getItem(LOCAL_STORAGE_KEYS.resumeSource);
        var savedJob = localStorage.getItem(LOCAL_STORAGE_KEYS.job);
        if (savedResume && savedResumeSource === "pdf") {
          els.resume.value = savedResume;
          resumeLoadedFromPdf = true;
          count(els.resume, els.resumeCount);
        }
        if (savedJob) {
          els.job.value = savedJob;
          count(els.job, els.jobCount);
        }
      } catch (_) {}
    }

    // ---- STEP INDICATOR ----
    function updateSteps() {
      var hasResume = els.resume.value.trim().length > 0;
      var hasJob = els.job.value.trim().length > 0;

      els.step1.className = hasResume ? "step done" : "step active";
      els.step1.querySelector(".step-num").textContent = hasResume ? "\u2713" : "1";
      els.conn1.className = hasResume ? "step-connector done" : "step-connector";

      if (hasResume && hasJob) {
        els.step2.className = "step done";
        els.step2.querySelector(".step-num").textContent = "\u2713";
      } else if (hasResume) {
        els.step2.className = "step active";
        els.step2.querySelector(".step-num").textContent = "2";
      } else {
        els.step2.className = "step";
        els.step2.querySelector(".step-num").textContent = "2";
      }

      els.conn2.className = (hasResume && hasJob) ? "step-connector done" : "step-connector";

      if (hasResume && hasJob) {
        els.step3.className = "step active";
        els.step3.querySelector(".step-num").textContent = "3";
      } else {
        els.step3.className = "step";
        els.step3.querySelector(".step-num").textContent = "3";
      }
    }

    // ---- GENERATION COUNTER ----
    function updateGenCounter() {
      if (localDevMode) {
        els.genCounter.className = "gen-counter pro";
        els.genCounter.textContent = "Local dev mode (unlimited)";
        return;
      }

      var used = profileData.generations_used || 0;
      var limit = profileData.free_limit || 3;
      var remaining = Math.max(0, limit - used);
      var isPro = profileData.is_pro && profileData.subscription_status === "active";

      if (isPro) {
        els.genCounter.className = "gen-counter pro";
        els.genCounter.textContent = "Unlimited generations";
      } else if (remaining > 0) {
        els.genCounter.className = "gen-counter";
        els.genCounter.textContent = remaining + " / " + limit + " free remaining";
      } else {
        els.genCounter.className = "gen-counter exhausted";
        els.genCounter.textContent = "0 free generations left";
      }
    }

    async function extractPdfText(file) {
      var ok = await ensurePdfLibLoaded();
      if (!ok || !window.pdfjsLib || !pdfjsLib.getDocument) {
        throw new Error("PDF library failed to load");
      }
      var arrayBuffer = await file.arrayBuffer();
      var pdf;
      try {
        // Use main-thread parsing first to avoid worker/CSP/CDN issues.
        pdf = await pdfjsLib.getDocument({ data: arrayBuffer, disableWorker: true }).promise;
      } catch (_) {
        // Fallback to default behavior if main-thread parsing fails.
        pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      }
      var text = "";
      for (var i = 1; i <= pdf.numPages; i++) {
        var page = await pdf.getPage(i);
        var content = await page.getTextContent();
        var strings = content.items.map(function(it) { return it.str; });
        text += strings.join(" ") + "\n\n";
      }
      return text.trim();
    }

    function runLocalGeneration(jobDescription, resumeText, tone) {
      var resumeSnippet = resumeText.split(/\n+/).map(function(s) { return s.trim(); }).filter(Boolean).slice(0, 6);
      var jobSnippet = jobDescription.split(/\n+/).map(function(s) { return s.trim(); }).filter(Boolean).slice(0, 4);
      var primaryRole = (jobSnippet[0] || "this role").replace(/\s+/g, " ").trim();

      var lines = [];
      lines.push("Dear Hiring Manager,");
      lines.push("");
      lines.push("I am excited to apply for " + primaryRole + ".");
      lines.push("My background aligns well with the role, and I bring a " + tone + " communication style with strong execution.");
      lines.push("");
      if (resumeSnippet.length) {
        lines.push("Highlights from my experience:");
        for (var i = 0; i < resumeSnippet.length; i++) {
          lines.push("- " + resumeSnippet[i]);
        }
        lines.push("");
      }
      if (jobSnippet.length > 1) {
        lines.push("I am especially interested in your priorities around:");
        for (var j = 1; j < jobSnippet.length; j++) {
          lines.push("- " + jobSnippet[j]);
        }
        lines.push("");
      }
      lines.push("I would value the chance to contribute and discuss how I can support your team.");
      lines.push("");
      lines.push("Sincerely,");
      lines.push("[Your Name]");
      return lines.join("\n");
    }

    async function getValidSession() {
      if (!supabaseClient) return null;

      var sessionRes = await supabaseClient.auth.getSession();
      var session = sessionRes && sessionRes.data ? sessionRes.data.session : null;
      if (!session) return null;

      var expiresAt = (session.expires_at || 0) * 1000;
      if (expiresAt && (expiresAt - Date.now()) < 60000) {
        var refreshRes = await supabaseClient.auth.refreshSession();
        return refreshRes && refreshRes.data ? refreshRes.data.session : null;
      }
      return session;
    }

    // ---- PDF UPLOAD + AI SUMMARY ----
    els.resumePdf.addEventListener("change", async function(e) {
      var file = e.target.files && e.target.files[0];
      if (!file) return;
      if (file.size > MAX_RESUME_FILE_BYTES) {
        var fileMb = (file.size / (1024 * 1024)).toFixed(1);
        setToast("File is too large (" + fileMb + "MB). Max size is 20MB.");
        els.resumePdf.value = "";
        return;
      }
      var fileType = (file.type || "").toLowerCase();
      var fileName = (file.name || "").toLowerCase();
      if (fileType !== "application/pdf" && !fileName.endsWith(".pdf")) {
        setToast("Only PDF files are supported.");
        els.resumePdf.value = "";
        return;
      }

      // Check auth - need a session to call the server endpoint
      if (!supabaseClient) {
        if (localDevMode) {
          try {
            els.status.textContent = "Reading PDF...";
            els.resume.value = await extractPdfText(file);
            resumeLoadedFromPdf = true;
            lastResumeUploadError = "";
            count(els.resume, els.resumeCount);
            updateSteps();
            autoSave();
            els.status.textContent = "Ready";
            setToast("Resume imported (local mode).", true);
            setTimeout(function() { els.job.focus(); }, 300);
          } catch (_) {
            els.status.textContent = "Error";
            console.error("PDF read failed (local mode):", _);
            lastResumeUploadError = "PDF read failed: " + ((_.message || "unknown error"));
            setToast(lastResumeUploadError);
          }
          return;
        }
        setToast(getAppNotReadyMessage());
        return;
      }
      var session = await getValidSession();
      if (!session) {
        // Fall back to client-side text extraction if not logged in
        try {
          els.status.textContent = "Reading PDF...";
          els.resume.value = await extractPdfText(file);
          resumeLoadedFromPdf = true;
          lastResumeUploadError = "";
          count(els.resume, els.resumeCount);
          updateSteps();
          autoSave();
          els.status.textContent = "Ready";
          setToast("Resume imported! Sign in to get an AI-powered summary.", true);
          setTimeout(function() { els.job.focus(); }, 300);
        } catch (err) {
          els.status.textContent = "Error";
          console.error("PDF read failed (no session):", err);
          lastResumeUploadError = "PDF read failed: " + ((err && err.message) || "unknown error");
          setToast(lastResumeUploadError);
        }
        return;
      }

      // Server-side upload flow with status progression
      els.status.textContent = "Uploading...";
      els.resumePdf.disabled = true;

      try {
        var formData = new FormData();
        formData.append("resume", file);

        els.status.textContent = "Reading...";

        var res = await fetch("/api/resume-upload", {
          method: "POST",
          headers: { Authorization: "Bearer " + session.access_token },
          body: formData,
        });

        var data = await res.json();

        if (!res.ok) {
          if (data.error === "scanned_pdf") {
            els.status.textContent = "Scanned PDF";
            lastResumeUploadError = data.message || "This looks like a scanned PDF. Upload a text-based PDF.";
            setToast(lastResumeUploadError);
          } else {
            els.status.textContent = "Error";
            lastResumeUploadError = data.error || data.message || "PDF upload failed. Try a different PDF.";
            setToast(lastResumeUploadError);
          }
          els.resumePdf.disabled = false;
          return;
        }

        if (!data.cached) {
          els.status.textContent = "Summarizing...";
          // Small visual delay so the user sees the "Summarizing" status
          await new Promise(function(r) { setTimeout(r, 300); });
        }

        els.resume.value = data.summary || "";
        resumeLoadedFromPdf = true;
        lastResumeUploadError = "";
        count(els.resume, els.resumeCount);
        updateSteps();
        autoSave();
        els.status.textContent = "Ready";

        if (data.raw) {
          setToast(data.message || "Raw text extracted (AI summary unavailable).", true);
        } else if (data.cached) {
          setToast("Resume summary loaded! Now paste a job description.", true);
        } else {
          setToast("Resume summarized! Now paste a job description.", true);
        }

        setTimeout(function() { els.job.focus(); }, 300);
      } catch (err) {
        els.status.textContent = "Error";
        console.error("PDF upload failed:", err);
        lastResumeUploadError = "PDF upload failed: " + ((err && err.message) || "unknown error");
        setToast(lastResumeUploadError);
      } finally {
        els.resumePdf.disabled = false;
      }
    });

    // ---- EMAIL MODAL (invisible account creation) ----
    var pendingGenerateAfterAuth = false;

    function openEmailModal() {
      els.emailModal.classList.add("active");
      els.emailInput.value = "";
      els.emailModalToast.style.display = "none";
      setTimeout(function() { els.emailInput.focus(); }, 100);
    }

    function closeEmailModal() {
      els.emailModal.classList.remove("active");
    }

    els.emailModalClose.onclick = closeEmailModal;
    els.emailModal.addEventListener("click", function(e) {
      if (e.target === els.emailModal) closeEmailModal();
    });

    els.switchToLogin.onclick = function() {
      closeEmailModal();
      openLoginModal("login");
    };

    els.emailSubmit.onclick = async function() {
      if (!supabaseClient) return setModalToast(els.emailModalToast, getAppNotReadyMessage());
      var email = (els.emailInput.value || "").trim();
      if (!email || email.indexOf("@") === -1) return setModalToast(els.emailModalToast, "Enter a valid email address.");

      els.emailSubmit.disabled = true;
      els.emailSubmit.textContent = "Creating account...";

      var autoPassword = crypto.randomUUID();
      var result = await supabaseClient.auth.signUp({
        email: email,
        password: autoPassword,
        options: { emailRedirectTo: window.location.origin }
      });

      if (result.error) {
        if (result.error.message.toLowerCase().indexOf("already") !== -1 || result.error.status === 422) {
          els.emailSubmit.disabled = false;
          els.emailSubmit.textContent = "Continue";
          closeEmailModal();
          openLoginModal("login");
          els.modalEmail.value = email;
          setModalToast(els.modalToast, "This account already exists. Please sign in.");
          return;
        }
        els.emailSubmit.disabled = false;
        els.emailSubmit.textContent = "Continue";
        return setModalToast(els.emailModalToast, result.error.message);
      }

      if (result.data.user && !result.data.session) {
        els.emailSubmit.disabled = false;
        els.emailSubmit.textContent = "Continue";
        setModalToast(els.emailModalToast, "Check your email to confirm your account, then sign in.", true);
        return;
      }

      els.emailSubmit.disabled = false;
      els.emailSubmit.textContent = "Continue";
      closeEmailModal();
      setToast("Account created!", true);
      await refreshAuthUI();

      if (pendingGenerateAfterAuth) {
        pendingGenerateAfterAuth = false;
        setTimeout(function() { els.generate.click(); }, 300);
      }
    };

    // ---- LOGIN MODAL ----
    var modalMode = "login";

    function openLoginModal(mode) {
      modalMode = mode || "login";
      updateLoginModalUI();
      els.loginModal.classList.add("active");
      els.modalEmail.value = "";
      els.modalPassword.value = "";
      els.modalToast.style.display = "none";
      setTimeout(function() { els.modalEmail.focus(); }, 100);
    }

    function closeLoginModal() {
      els.loginModal.classList.remove("active");
    }

    function updateLoginModalUI() {
      if (modalMode === "login") {
        els.modalTitle.textContent = "Sign in";
        els.modalSubtitle.textContent = "Welcome back! Sign in to your account.";
        els.modalLoginBtn.textContent = "Sign in";
        els.modalLoginBtn.style.display = "";
        els.modalSignupBtn.style.display = "none";
        els.modalSwitch.innerHTML = 'Don\'t have an account? <a id="modalSwitchLink">Sign up</a>';
      } else {
        els.modalTitle.textContent = "Create your account";
        els.modalSubtitle.textContent = "Sign up to start generating cover letters.";
        els.modalLoginBtn.style.display = "none";
        els.modalSignupBtn.textContent = "Create account";
        els.modalSignupBtn.style.display = "";
        els.modalSwitch.innerHTML = 'Already have an account? <a id="modalSwitchLink">Sign in</a>';
      }
      document.getElementById("modalSwitchLink").onclick = function() {
        modalMode = modalMode === "login" ? "signup" : "login";
        updateLoginModalUI();
      };
    }

    els.modalClose.onclick = closeLoginModal;
    els.loginModal.addEventListener("click", function(e) {
      if (e.target === els.loginModal) closeLoginModal();
    });

    els.navLogin.onclick = function() { openLoginModal("login"); };
    els.navSignup.onclick = function() { openLoginModal("signup"); };

    els.modalLoginBtn.onclick = async function() {
      if (!supabaseClient) return setModalToast(els.modalToast, getAppNotReadyMessage());
      var email = (els.modalEmail.value || "").trim();
      var password = els.modalPassword.value || "";
      if (!email || !password) return setModalToast(els.modalToast, "Enter email and password.");
      els.modalLoginBtn.disabled = true;
      els.modalLoginBtn.textContent = "Signing in...";
      var result = await supabaseClient.auth.signInWithPassword({ email: email, password: password });
      els.modalLoginBtn.disabled = false;
      els.modalLoginBtn.textContent = "Sign in";
      if (result.error) {
        var loginErr = (result.error.message || "").toLowerCase();
        if (loginErr.indexOf("not confirmed") !== -1 || loginErr.indexOf("email not confirmed") !== -1) {
          setModalToast(els.modalToast, "Email not confirmed. If you disabled confirmations in Supabase, create a fresh account or sign in.");
          return;
        }
        return setModalToast(els.modalToast, result.error.message);
      }
      closeLoginModal();
      setToast("Signed in!", true);
      await refreshAuthUI();
      if (pendingGenerateAfterAuth) {
        pendingGenerateAfterAuth = false;
        setTimeout(function() { els.generate.click(); }, 300);
      }
    };

    els.modalSignupBtn.onclick = async function() {
      if (!supabaseClient) return setModalToast(els.modalToast, getAppNotReadyMessage());
      var email = (els.modalEmail.value || "").trim();
      var password = els.modalPassword.value || "";
      if (!email || !password) return setModalToast(els.modalToast, "Enter email and password.");
      if (password.length < 6) return setModalToast(els.modalToast, "Password must be at least 6 characters.");
      els.modalSignupBtn.disabled = true;
      els.modalSignupBtn.textContent = "Creating account...";
      var result = await supabaseClient.auth.signUp({
        email: email,
        password: password,
        options: { emailRedirectTo: window.location.origin }
      });
      els.modalSignupBtn.disabled = false;
      els.modalSignupBtn.textContent = "Create account";
      if (result.error) {
        var signupErr = (result.error.message || "").toLowerCase();
        if (signupErr.indexOf("already") !== -1 || result.error.status === 422) {
          setModalToast(els.modalToast, "This account already exists. Please sign in.");
          return;
        }
        return setModalToast(els.modalToast, result.error.message);
      }
      if (result.data.user && !result.data.session) {
        setModalToast(els.modalToast, "Account created. Check your Supabase email-confirmation settings if auto-login did not occur.", true);
      } else {
        closeLoginModal();
        setToast("Account created!", true);
        await refreshAuthUI();
      }
    };

    // ---- AUTH UI ----
    async function refreshAuthUI() {
      if (!supabaseClient) return;
      var session = await getValidSession();
      var loggedIn = !!(session && session.user);
      currentUser = loggedIn ? session.user : null;

      els.navLogin.style.display = loggedIn ? "none" : "";
      els.navSignup.style.display = loggedIn ? "none" : "";
      els.logout.style.display = loggedIn ? "" : "none";
      els.authStatus.textContent = loggedIn ? session.user.email : "";

      if (loggedIn) {
        // Low-usage mode: avoid auth-time API calls.
        // Profile usage is updated during generation/checkouts and local counters.
        if (!profileData || typeof profileData !== "object") {
          profileData = { is_pro: false, subscription_status: "none", generations_used: 0, free_limit: 3 };
        }

        profileData.generations_used = Math.max(
          profileData.generations_used || 0,
          loadLocalGenerationUsed()
        );

        var isPro = profileData.is_pro && profileData.subscription_status === "active";
        els.pay.style.display = isPro ? "none" : "";
      } else {
        profileData = { is_pro: false, subscription_status: "none", generations_used: 0, free_limit: 3 };
        els.pay.style.display = "none";
      }

      updateGenCounter();
      updateGenerateButton();
    }

    function updateGenerateButton() {
      if (isGenerating) return;
      els.generate.textContent = "Generate";
      els.generate.disabled = false;
      els.retry.disabled = false;
    }

    els.logout.onclick = async function() {
      if (!supabaseClient) return;
      await supabaseClient.auth.signOut();
      currentUser = null;
      profileData = { is_pro: false, subscription_status: "none", generations_used: 0, free_limit: 3 };
      setToast("Logged out.", true);
      await refreshAuthUI();
    };

    // ---- STRIPE CHECKOUT ----
    async function startCheckout() {
      if (localDevMode) {
        setToast("Checkout disabled in local dev mode.");
        return;
      }
      if (!supabaseClient) return;
      var session = await getValidSession();
      if (!session) {
        openEmailModal();
        return;
      }
      try {
        var r = await fetch("/api/stripe/create-checkout-session", {
          method: "POST",
          headers: { Authorization: "Bearer " + session.access_token }
        });
        var data = await r.json();
        if (!r.ok) return setToast(data.error || "Checkout failed");
        window.location.href = data.url;
      } catch (err) {
        setToast("Could not start checkout. Try again.");
      }
    }

    els.pay.onclick = startCheckout;
    els.paywallUpgrade.onclick = startCheckout;

    // ---- SAMPLE DATA ----
    els.sample.onclick = function() {
      els.job.value = "We're hiring a Frontend Engineer to build polished, user-friendly experiences. You'll work with product and design to ship fast, care about accessibility, and communicate clearly. Bonus: experience with APIs and performance tuning.";
      count(els.job, els.jobCount);
      updateSteps();
      autoSave();
      setToast("Sample job description loaded. Upload a resume PDF to continue.", true);
    };

    els.retry.onclick = function() {
      if (isGenerating) return;
      els.generate.click();
    };

    // ---- CLEAR ----
    els.clear.onclick = function() {
      els.job.value = "";
      els.resume.value = "";
      resumeLoadedFromPdf = false;
      lastResumeUploadError = "";
      els.output.textContent = "Your generated cover letter will appear here.";
      els.status.textContent = "Ready";
      els.outputWrap.classList.remove("locked");
      lastGeneratedText = "";
      count(els.job, els.jobCount);
      count(els.resume, els.resumeCount);
      updateSteps();
      autoSave();
    };

    // ---- COPY ----
    els.copy.onclick = async function() {
      var text = lastGeneratedText || els.output.textContent || "";
      if (!text || text === "Your generated cover letter will appear here.") {
        return setToast("Nothing to copy yet.");
      }
      if (els.outputWrap.classList.contains("locked")) {
        return setToast("Upgrade to copy the full cover letter.");
      }
      try {
        await navigator.clipboard.writeText(text);
        setToast("Copied to clipboard.", true);
      } catch (e) {
        setToast("Copy failed. Select text manually.");
      }
    };

    // ---- DOWNLOAD ----
    els.download.onclick = function() {
      if (els.outputWrap.classList.contains("locked")) {
        return setToast("Upgrade to download the full cover letter.");
      }
      var text = lastGeneratedText || els.output.textContent || "";
      if (!text || text === "Your generated cover letter will appear here.") {
        return setToast("Nothing to download yet.");
      }
      var blob = new Blob([text], { type: "text/plain" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "cover-letter.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      setToast("Downloaded!", true);
    };

    // ---- GENERATE ----
    els.generate.onclick = async function() {
      if (isGenerating) return;

      var jobDescription = els.job.value.trim();
      var resumeText = els.resume.value.trim();
      var tone = els.tone.value;

      if (!resumeText || !resumeLoadedFromPdf) {
        setToast(lastResumeUploadError || "Upload your resume PDF first.");
        els.resumePdf.focus();
        return;
      }

      if (!jobDescription) {
        setToast("Paste a job description.");
        els.job.focus();
        return;
      }

      var session = null;
      if (!localDevMode) {
        // If not logged in, show email modal for invisible account creation
        if (!supabaseClient) return setToast(getAppNotReadyMessage());
        session = await getValidSession();
        if (!session) {
          pendingGenerateAfterAuth = true;
          openEmailModal();
          return;
        }

        // Pre-check free limit (server enforces too)
        var isPro = profileData.is_pro && profileData.subscription_status === "active";
        var freeRemaining = Math.max(0, (profileData.free_limit || 3) - (profileData.generations_used || 0));
        if (!isPro && freeRemaining <= 0) {
          setToast("You've used all free generations. Upgrade for unlimited access.");
          startCheckout();
          return;
        }
      }

      // Start generation
      isGenerating = true;
      els.generate.disabled = true;
      els.retry.disabled = true;
      els.generate.textContent = "Generating...";
      els.status.textContent = "Generating...";
      els.output.style.display = "none";
      els.loadingState.classList.add("active");
      els.outputWrap.classList.remove("locked");

      try {
        var data;
        var r;
        if (localDevMode) {
          await new Promise(function(resolve) { setTimeout(resolve, 400); });
          data = { text: runLocalGeneration(jobDescription, resumeText, tone), locked: false };
        } else {
          r = await fetch("/api/generate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + session.access_token,
            },
            body: JSON.stringify({ jobDescription: jobDescription, resume: resumeText, tone: tone }),
          });
          var rawBody = await r.text();
          try {
            data = rawBody ? JSON.parse(rawBody) : {};
          } catch (_) {
            data = { error: rawBody || "Invalid server response" };
          }
        }

        els.loadingState.classList.remove("active");
        els.output.style.display = "";

        if (r && !r.ok) {
          if (r.status === 403 && data.error === "limit_reached") {
            profileData.generations_used = data.generations_used || profileData.generations_used;
            saveLocalGenerationUsed(profileData.generations_used || 0);
            updateGenCounter();
            setToast(data.message || "Free generations exhausted. Upgrade for unlimited.");
            startCheckout();
            return;
          }
          // Hard fallback: never block the user on provider/backend issues.
          if (!(profileData.is_pro && profileData.subscription_status === "active")) {
            profileData.generations_used = (profileData.generations_used || 0) + 1;
            saveLocalGenerationUsed(profileData.generations_used);
            updateGenCounter();
          }
          var fallbackTextFromError = runLocalGeneration(jobDescription, resumeText, tone);
          lastGeneratedText = fallbackTextFromError;
          els.output.textContent = fallbackTextFromError;
          els.outputWrap.classList.remove("locked");
          els.status.textContent = "Done (Fallback)";
          setToast("AI provider unavailable. Generated fallback cover letter instead.", true);
          return;
        }

        var fullText = (data.text || "").trim();
        var previewText = (data.preview || "").trim();

        if (data.generations_used !== undefined) {
          profileData.generations_used = data.generations_used;
          saveLocalGenerationUsed(profileData.generations_used || 0);
        }
        if (data.free_limit !== undefined) {
          profileData.free_limit = data.free_limit;
        }
        updateGenCounter();

        // If locked, render only preview text on the client.
        if (data.locked) {
          var visiblePreview = previewText || "Preview unavailable.";
          lastGeneratedText = visiblePreview;
          els.output.textContent = visiblePreview;
          els.outputWrap.classList.add("locked");
          els.status.textContent = "Preview";
        } else {
          lastGeneratedText = fullText;
          els.output.textContent = lastGeneratedText || "No output returned.";
          els.outputWrap.classList.remove("locked");
          els.status.textContent = localDevMode ? "Done (Local)" : "Done";
        }

        setToast(localDevMode ? "Cover letter generated in local dev mode." : "Cover letter generated!", true);
      } catch (e) {
        els.loadingState.classList.remove("active");
        els.output.style.display = "";
        if (!(profileData.is_pro && profileData.subscription_status === "active")) {
          profileData.generations_used = (profileData.generations_used || 0) + 1;
          saveLocalGenerationUsed(profileData.generations_used);
          updateGenCounter();
        }
        var fallbackTextOnCatch = runLocalGeneration(jobDescription, resumeText, tone);
        lastGeneratedText = fallbackTextOnCatch;
        els.output.textContent = fallbackTextOnCatch;
        els.outputWrap.classList.remove("locked");
        els.status.textContent = "Done (Fallback)";
        setToast("AI request failed. Generated fallback cover letter instead.", true);
      } finally {
        isGenerating = false;
        els.generate.disabled = false;
        els.retry.disabled = false;
        els.generate.textContent = "Generate";
      }
    };

    // Handle Enter/Escape in modals
    document.addEventListener("keydown", function(e) {
      if (els.emailModal.classList.contains("active")) {
        if (e.key === "Escape") closeEmailModal();
        if (e.key === "Enter") els.emailSubmit.click();
        return;
      }
      if (els.loginModal.classList.contains("active")) {
        if (e.key === "Escape") closeLoginModal();
        if (e.key === "Enter") {
          if (modalMode === "login") els.modalLoginBtn.click();
          else els.modalSignupBtn.click();
        }
      }
    });

    // ---- INIT ----
    (async function init() {
      loadSaved();
      updateSteps();

      // Auto-focus resume PDF uploader if resume is empty
      if (!els.resume.value.trim()) {
        setTimeout(function() { els.resumePdf.focus(); }, 200);
      }

      try {
        var configRes = await fetch("/api/config");
        if (!configRes.ok) {
          throw new Error("`/api/config` is unavailable. Run with `netlify dev` so functions are served.");
        }
        var cfg = await configRes.json();

        if (!cfg.supabaseUrl || !cfg.supabaseAnonKey) {
          appInitError = "Supabase is not configured. Set SUPABASE_URL and SUPABASE_ANON_KEY in Netlify env vars.";
          console.warn(appInitError);
          if (canUseLocalDevMode()) {
            enableLocalDevMode(appInitError);
          } else {
            els.authStatus.textContent = "Setup required";
            setToast(appInitError);
            updateGenCounter();
          }
          return;
        }

        supabaseClient = supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
        supabaseClient.auth.onAuthStateChange(function() { refreshAuthUI(); });
        await refreshAuthUI();
      } catch (err) {
        appInitError = err && err.message
          ? err.message
          : "App failed to initialize. Check `/api/config` and Netlify function logs.";
        console.error("Failed to load app config:", err);
        if (canUseLocalDevMode()) {
          enableLocalDevMode(appInitError);
        } else {
          els.authStatus.textContent = "Setup required";
          setToast(appInitError);
          updateGenCounter();
        }
      }
    })();
  </script>
</body>
</html>
